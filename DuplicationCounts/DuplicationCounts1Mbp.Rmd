---
title: "DuplicationsPlotting"
author: "Louie Alexander, modified from Will's code"
date: '2022-05-26'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#change access and/or change setwd for your computer
access = "Louie"

if(access =="Louie") {
  setwd("C:\\Users\\louie\\Desktop\\ResearchFiles\\RPlotting")
}

```

```{r}

if (!require(readxl)) {
  install.packages("readxl")
}
if (!require(tidyverse)) {
  install.packages("tidyverse")
}
if (!require(reshape2)) {
  install.packages("reshape2")
}

library(readxl)
library(tidyverse)
library(reshape2)

```

```{r}
#This is the ".vcf" file for Duplications that documents which strains a given duplication occurs in
duplications <- read.table("duplicationCounts_Example.vcf",header=TRUE,sep = '\t')
```

```{r}
chromosome <- duplications 

#This splits the chromosome into "steps" of 1M bp in size
chromosome$interval = floor(chromosome$POS/1000000)
```

```{r}
CA_filtered <- chromosome %>% filter(CA != '0/0')
pi655_filtered <- chromosome %>% filter(X655972 != '0/0')
pi510_filtered <- chromosome %>% filter(X510757 != '0/0')
pi506_filtered <- chromosome %>% filter(X506069 != '0/0')
pi329_filtered <- chromosome %>% filter(X329311 != '0/0')    
pi300_filtered <- chromosome %>% filter(X300119 != '0/0')     
leoti_filtered <- chromosome %>% filter(leoti != '0/0')        
pi229_filtered <- chromosome %>% filter(pi229841 != '0/0')
pi297_filtered <- chromosome %>% filter(pi297155 != '0/0')    
rio_filtered <- chromosome %>% filter(rio != '0/0')   
```

```{r}
#This counts the numbers of features per 1M bp
CA = CA_filtered %>% group_by(CHROM) %>% count(interval) %>% rename(CA = n)
pi655 = pi655_filtered %>% group_by(CHROM) %>% count(interval) %>% rename(pi655972 = n)
pi510 = pi510_filtered %>% group_by(CHROM) %>% count(interval) %>% rename(pi510757 = n)
pi506 = pi506_filtered %>% group_by(CHROM) %>% count(interval) %>% rename(pi506069 = n)
pi329 = pi329_filtered %>% group_by(CHROM) %>% count(interval) %>% rename(pi329311 = n)
pi300 = pi300_filtered %>% group_by(CHROM) %>% count(interval) %>% rename(pi300119 = n)
leoti = leoti_filtered %>% group_by(CHROM) %>% count(interval) %>% rename(leoti = n)
pi229 = pi229_filtered %>% group_by(CHROM) %>% count(interval) %>% rename(pi229841 = n)
pi297 = pi297_filtered %>% group_by(CHROM) %>% count(interval) %>% rename(pi297155 = n)
rio = rio_filtered %>% group_by(CHROM) %>% count(interval)  %>% rename(rio = n)
```

```{r}
merges <- full_join(CA, pi655)
merges <- full_join(merges, pi510)
merges <- full_join(pi506, merges)
merges <- full_join(pi329, merges)
#merges <- full_join(pi300, merges) commented out because the grassl line (300119) is neither a sweet nor biomass variety
merges <- full_join(leoti, merges)
merges <- full_join(pi229, merges)
merges <- full_join(pi297, merges)
merges <- full_join(rio, merges)

```

```{r}
#add averages for merged freqs for sweet variety and biomass variety, then make sure that strains with 0 features at a given column have 0 instead of NA:
avg_Distance <- merges %>% mutate(sweetAVG = 0, biomassAVG = 0, 
                            rio = ifelse(is.na(rio), 0, rio), pi297155 = ifelse(is.na(pi297155), 0, pi297155), pi229841 = ifelse(is.na(pi229841), 0, pi229841), leoti = ifelse(is.na(leoti), 0, leoti), pi329311 = ifelse(is.na(pi329311), 0, pi329311), pi506069 = ifelse(is.na(pi506069), 0, pi506069), 
                            pi510757 = ifelse(is.na(pi510757), 0, pi510757), pi655972 = ifelse(is.na(pi655972), 0, pi655972), CA = ifelse(is.na(CA), 0, CA)) 

#order the dataframe by interval
avg_Distance <- avg_Distance[order(avg_Distance$interval),]

#Go through each row to find means for sweet and biomass
for (row in 1:nrow(avg_Distance)) {
  #add avg for Sweet sorghum
  avg_Distance[row,12] = round(mean(c(avg_Distance[row,"rio"], avg_Distance[row,"CA"], avg_Distance[row,"leoti"])), 2)
  #add avg for Biomass sorghum
  avg_Distance[row,13] = round(mean(c(avg_Distance[row,"pi655972"], avg_Distance[row,"pi510757"], avg_Distance[row,"pi506069"], avg_Distance[row,"pi329311"], avg_Distance[row,"pi229841"], avg_Distance[row,"pi297155"])), 2) 
} 

avg_Distance <- avg_Distance %>% mutate(distance = abs(sweetAVG - biomassAVG))
top5Divergent <- avg_Distance[order(-avg_Distance$distance),][1:5,]
```


```{r}
data_long <- melt(merges, id = "interval")
gfg_plot <- ggplot(data_long,            
                   aes(x = interval,
                       y = value,
                       color = variable,main = "plot")) +  geom_line() + ggtitle("Chromosome 01 Frequency of Duplications") + xlab("Interval (1M bp)") + ylab("Number of Features")
gfg_plot

```

```{r}
#Change line below to pull desired chromosome
chrOfInterest <- avg_distance %>% filter(CHROM == "Chr01")

#Plots avg difference between sweet and biomass strains for each interval of given chromosome
avg_Distance %>% ggplot(aes(x=interval, y=distance)) + geom_col() + ggtitle("Chromosome __ Average Difference in Number of Duplications") + xlab("Interval (1M bp)") + ylab("Average Difference (count)")

```

#write out a csv of duplications per interval, and change name to appropriate chromosome
```{r}
write.csv(avg_Distance, "DuplicationsPerInterval.csv")
```

